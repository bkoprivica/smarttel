name: CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v2

      - name: Set up JDK 11
        uses: actions/setup-java@v2
        with:
          distribution: 'temurin'
          java-version: 11

      - name: Build All Projects with Maven
        run: |
          mvn clean package -DskipTests --projects customer-service,billing-service,notification-service,api-gateway --also-make

      - name: Build Docker Images
        run: |
          docker build -t ghcr.io/bkoprivica/customer-service:latest ./customer-service
          docker build -t ghcr.io/bkoprivica/billing-service:latest ./billing-service
          docker build -t ghcr.io/bkoprivica/notification-service:latest ./notification-service
          docker build -t ghcr.io/bkoprivica/api-gateway:latest ./api-gateway

      - name: Log in to GitHub Container Registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Push Docker Images
        run: |
          docker push ghcr.io/bkoprivica/customer-service:latest
          docker push ghcr.io/bkoprivica/billing-service:latest
          docker push ghcr.io/bkoprivica/notification-service:latest
          docker push ghcr.io/bkoprivica/api-gateway:latest

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Checkout Code
        uses: actions/checkout@v2

      - name: Set up Kubectl
        uses: azure/setup-kubectl@v1
        with:
          version: 'latest'

      - name: Configure KUBECONFIG
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG }}" > $HOME/.kube/config

      - name: Install MetalLB
        run: |
          # Install MetalLB namespace and resources
          kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.13.7/manifests/namespace.yaml
          kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.13.7/manifests/metallb.yaml
          # Configure MetalLB with the provided IP range (set METALLB_IP_RANGE in repo secrets)
          cat <<EOF | kubectl apply -f -
          apiVersion: v1
          kind: ConfigMap
          metadata:
            namespace: metallb-system
            name: config
          data:
            config: |
              address-pools:
              - name: default
                protocol: layer2
                addresses:
                - "${{ secrets.METALLB_IP_RANGE }}"
          EOF

      - name: Deploy to Killercoda Kubernetes
        run: |
          kubectl apply -f k8s/
